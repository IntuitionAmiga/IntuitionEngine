name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  APP_NAME: IntuitionEngine
  GO_VERSION_FILE: go.mod

jobs:
  # ---------------------------------------------------------------------------
  # Linux official build (native amd64 only in CI)
  # ---------------------------------------------------------------------------
  linux:
    name: Linux amd64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libgl1-mesa-dev libxcursor-dev libxi-dev libxinerama-dev libxrandr-dev libxxf86vm-dev

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: "1"
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          VERSION="${{ steps.version.outputs.version }}"
          go build -ldflags "-s -w -X main.Version=${VERSION} -X main.Commit=${COMMIT} -X main.BuildDate=${BUILD_DATE}" .

      - name: Build SDK tools
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: "0"
        run: |
          go build -ldflags "-s -w" -o ie32asm assembler/ie32asm.go
          go build -ldflags "-s -w" -tags ie64 -o ie64asm assembler/ie64asm.go
          go build -ldflags "-s -w" -o ie32to64 ./cmd/ie32to64/

      - name: UPX compress binaries
        run: |
          sudo apt-get install -y upx-ucl
          upx IntuitionEngine ie32asm ie64asm ie32to64

      - name: Create tar.xz archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DIR="${APP_NAME}-${VERSION}-linux-amd64"
          mkdir -p "${DIR}"
          cp IntuitionEngine ie32asm ie64asm ie32to64 "${DIR}/"
          cp README.md CHANGELOG.md DEVELOPERS.md "${DIR}/" 2>/dev/null || true
          cp -r sdk/ "${DIR}/sdk/" 2>/dev/null || true
          tar -cJf "${DIR}.tar.xz" "${DIR}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: ${{ env.APP_NAME }}-*-linux-amd64.tar.xz

  # ---------------------------------------------------------------------------
  # Windows (amd64 + arm64) â€” novulkan, cross-compiled
  # ---------------------------------------------------------------------------
  windows:
    name: Windows ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
            upx: true
          - arch: arm64
            goarch: arm64
            upx: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build
        env:
          GOOS: windows
          GOARCH: ${{ matrix.goarch }}
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          VERSION="${{ steps.version.outputs.version }}"
          go build -ldflags "-s -w -X main.Version=${VERSION} -X main.Commit=${COMMIT} -X main.BuildDate=${BUILD_DATE}" -tags novulkan .
          go build -ldflags "-s -w" -o ie32asm.exe assembler/ie32asm.go
          go build -ldflags "-s -w" -tags ie64 -o ie64asm.exe assembler/ie64asm.go
          go build -ldflags "-s -w" -o ie32to64.exe ./cmd/ie32to64/

      - name: UPX compress binaries
        if: ${{ matrix.upx }}
        run: |
          sudo apt-get install -y upx-ucl
          upx IntuitionEngine.exe ie32asm.exe ie64asm.exe ie32to64.exe

      - name: Create zip archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DIR="${APP_NAME}-${VERSION}-windows-${{ matrix.arch }}"
          mkdir -p "${DIR}"
          cp IntuitionEngine.exe ie32asm.exe ie64asm.exe ie32to64.exe "${DIR}/"
          cp README.md CHANGELOG.md DEVELOPERS.md "${DIR}/" 2>/dev/null || true
          cp -r sdk/ "${DIR}/sdk/" 2>/dev/null || true
          zip -r "${DIR}.zip" "${DIR}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: ${{ env.APP_NAME }}-*-windows-${{ matrix.arch }}.zip

  # ---------------------------------------------------------------------------
  # Commented out: macOS requires CGO for ebiten/oto. Re-enable when upstream goes purego.
  # ---------------------------------------------------------------------------
  # macos:
  #   name: macOS ${{ matrix.arch }}
  #   runs-on: ubuntu-latest
  #   ...

  # ---------------------------------------------------------------------------
  # Publish GitHub Release with checksums
  # ---------------------------------------------------------------------------
  release:
    name: Publish release
    needs: [linux, windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name '*.tar.xz' -o -name '*.zip' \) -exec cp {} release/ \;

      - name: Generate checksums
        working-directory: release
        run: sha256sum * > SHA256SUMS

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          # Extract the section for this version from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            awk "/^## .*${VERSION}/,/^## /" CHANGELOG.md | head -n -1 > release_notes.md
            # If empty, use a default
            if [ ! -s release_notes.md ]; then
              echo "Release ${GITHUB_REF_NAME}" > release_notes.md
            fi
          else
            echo "Release ${GITHUB_REF_NAME}" > release_notes.md
          fi

          # Append platform notes
          cat >> release_notes.md <<'EOF'

          ---

          ### Platform support

          | Platform | Status | Notes |
          |----------|--------|-------|
          | Linux amd64 | Official | Full feature set |
          | Windows amd64 | Experimental | novulkan (software Voodoo) |
          | Windows arm64 | Experimental | novulkan (software Voodoo) |

          ### Checksums
          See `SHA256SUMS` for file integrity verification:
          ```
          sha256sum -c SHA256SUMS
          ```
          EOF
          sed -i 's/^          //' release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: release/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
